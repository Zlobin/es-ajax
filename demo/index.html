<!doctype html>
<html>
  <body>
    <label for="xhr-id">URL:
      <input type="text" name="url" value="/demo/server.php" id="url">
    </label><br>
    <label for="timeout">Timeout for request (sec):
      <input type="text" name="timeout" value="0" id="timeout">
    </label><br>
    <label for="timeout-response">Timeout for response (sec):
      <input type="text" name="timeout-response" value="0" id="timeout-response">
    </label><br>
    <label for="type">Content type:
      <select name="type" id="type">
        <option value="text">plain text</option>
        <option value="json" selected>json</option>
      </select>
    </label><br>
    <label for="method">Method:
      <select name="method" id="method">
        <option value="head">HEAD</option>
        <option value="options">OPTIONS</option>
        <option value="get" selected>GET</option>
        <option value="post">POST</option>
        <option value="put">PUT</option>
        <option value="del">DELETE</option>
        <option value="file">FILE</option>
      </select>
    </label><br>
    <label for="file" id="file-block" style="display: none">Select file:
      <input type="file" name="file" id="file"><br>
    </label>
    <label for="xhr-id">REQUEST id:
      <input type="text" style="width: 400px" name="xhr-id" disabled value="" id="xhr-id">
    </label><br>
    <label for="output">Output:
      <div style="width: 500px; height: 200px; overflow: scroll">
        <pre>
          <code id="output"></code>
        </pre>
      </div>
    </label><br><br>
    <button id="send">Send</button> |
    <button id="cancel">Cancel</button> |
    <button id="all">Get all requests</button> |
    <button id="apply-middleware">Apply middleware</button> |
    <button id="clear-middleware">Clear middleware</button>

    <script src="../dist/bundle.js"></script>
    <script>
      (function(document, ajax) {
        var byId = document.getElementById.bind(document);
        var send = byId('send');
        var all = byId('all');
        var xhrId = byId('xhr-id');
        var output = byId('output');
        var file = byId('file');
        var method = byId('method');
        var fileBlock = byId('file-block');
        var activeRequest = null;
        // For checking json object as parameters
        // with nested objects and arrays.
        var nestedParams = {
          'test': 'test2',
          'foo': 'bar',
          'nested': {
            'bar': 'baz',
            'foo': 'bar',
            'imarraytoo': [
              'baz',
              'foo',
              'bar'
            ]
          },
          'imarray': [
            'foo',
            'bar',
            'baz'
          ]
        };
        var responseOut = function(response) {
          return JSON.stringify(response, undefined, 4);
        };
        var onProgress = function(percentage) {
          console.log('Percentage: ' + percentage);
        };
        var prepareUrl = function(elementId) {
          var timeoutResponse = parseInt(byId('timeout-response').value, 10);
          var url = byId(elementId).value;

          // Set timeout for answers from the server.
          if (timeoutResponse > 0) {
            url += '?timeout=' + timeoutResponse;
          }

          return url;
        };
        var prepareFile = function(fieldName) {
          var files = file.files;
          var formData = new FormData();

          formData.append(fieldName, files[0], files[0].name);

          return formData;
        };

        send.addEventListener('click', function(event) {
          var url = prepareUrl('url');
          var type = byId('type').value;
          var timeout = parseInt(byId('timeout').value, 10);
          var parameters = {
            type: type,
            // For testing custom headers.
            headers: {
              'foo': 'bar',
              'bar': 'baz'
            }
          };
          var request = ajax(url, parameters);
          var params = null;

          activeRequest = request;
          // Translate timeout from seconds to ms.
          request
            .setTimeout(timeout * 1000)
            .onProgress(onProgress);

          xhrId.value = request.getXhrId().toString();

          if (method.value === 'file') {
            if (file.files.length) {
              params = prepareFile('file');
            } else {
              output.innerHTML = 'You should select a file';
              return;
            }
          }

          request[method.value](params)
            .then(function(response) {
              console.log(method.value + ' OK');
              output.innerHTML = responseOut(response);
            })
            .catch(function(response) {
              console.log(method.value + ' FAIL');
              output.innerHTML = responseOut(response);
            });
        });

        cancel.addEventListener('click', function(event) {
          if (activeRequest !== null) {
            activeRequest.cancel();
          }
        });

        all.addEventListener('click', function(event) {
          var allRequests = ajax().getAllRequests();

          output.value = 'All requests';
        });

        method.addEventListener('change', function(event) {
          fileBlock.style.display = (method.value === 'file'
            ? 'inline' : 'hidden');
        });
      })(document, ajax);
    </script>
  </body>
</html>
